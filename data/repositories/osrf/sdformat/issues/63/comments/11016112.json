{"links": {"self": {"href": "data/repositories/osrf/sdformat/issues/63/comments/11016112.json"}, "html": {"href": "#!/osrf/sdformat/issues/63#comment-11016112"}}, "issue": {"links": {"self": {"href": "data/repositories/osrf/sdformat/issues/63.json"}}, "type": "issue", "id": 63, "repository": {"links": {"self": {"href": "data/repositories/osrf/sdformat.json"}, "html": {"href": "#!/osrf/sdformat"}, "avatar": {"href": "data/bytebucket.org/ravatar/{b6d52f9f-b070-41c0-807c-94af07ea375b}ts=1606789"}}, "type": "repository", "name": "sdformat", "full_name": "osrf/sdformat", "uuid": "{b6d52f9f-b070-41c0-807c-94af07ea375b}"}, "title": "gzsdf segfaults in trusty"}, "content": {"raw": "**Problem description: **\n\nAfter fixing the problem with ROS urdfdom package, there is still a different error found by  @jbinney:\n\n```\njbinney@h-> gzsdf print nao.urdf \n*** Error in `gzsdf': free(): invalid pointer: 0x0000000001ea4b70 ***\nAborted (core dumped)\n\njbinney@h-> which gzsdf\n/usr/bin/gzsdf\n\njbinney@h-> ldd /usr/bin/gzsdf | grep urdf                                                                                                \n        liburdfdom_model.so.0.2 => /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2 (0x00007f1cb8542000)\n\njbinney@h-> dpkg -S /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2\nliburdfdom-model0.2:amd64: /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2\n```\n\nI run gdb against it and looks like the same issue that we [were fixing before](#!/osrf/sdformat/pull-request/77/support-to-use-external-urdf/diff#comment-917387).\n```\n(gdb) run print nao.urdf\nStarting program: /usr/bin/gzsdf print nao.urdf\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library \"/lib/x86_64-linux-gnu/libthread_db.so.1\".\n[New Thread 0x7fffe8338700 (LWP 4525)]\n*** Error in `/usr/bin/gzsdf': free(): invalid pointer: 0x00000000008ad5f0 ***\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff6db6f79 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\n56\t../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.\n(gdb) bt\n#0  0x00007ffff6db6f79 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\n#1  0x00007ffff6dba388 in __GI_abort () at abort.c:89\n#2  0x00007ffff6df41d4 in __libc_message (do_abort=do_abort@entry=1, fmt=fmt@entry=0x7ffff6f02a10 \"*** Error in `%s': %s: 0x%s ***\\n\") at ../sysdeps/posix/libc_fatal.c:175\n#3  0x00007ffff6e004ae in malloc_printerr (ptr=<optimized out>, str=0x7ffff6efeb03 \"free(): invalid pointer\", action=1) at malloc.c:4996\n#4  _int_free (av=<optimized out>, p=<optimized out>, have_lock=0) at malloc.c:3840\n#5  0x00007ffff768549e in boost::detail::sp_counted_base::release (this=0x8b8df0) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146\n#6  0x00007ffff76bb53d in ~shared_count (this=<synthetic pointer>, __in_chrg=<optimized out>) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371\n#7  ~shared_ptr (this=<synthetic pointer>, __in_chrg=<optimized out>) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328\n#8  ReduceVisualToParent (_link=..., _groupName=..., _visual=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:378\n#9  0x00007ffff76bbba4 in ReduceVisualsToParent (_link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:887\n#10 0x00007ffff76c671f in ReduceFixedJoints (_root=_root@entry=0x870a30, _link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:405\n#11 0x00007ffff76c6467 in ReduceFixedJoints (_root=_root@entry=0x870a30, _link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:390\n#12 0x00007ffff76c6f12 in sdf::URDF2SDF::InitModelString (this=this@entry=0x7fffffffde6d, _urdfStr=..., _enforceLimits=_enforceLimits@entry=true) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2667\n#13 0x00007ffff76c7514 in sdf::URDF2SDF::InitModelDoc (this=this@entry=0x7fffffffde6d, _xmlDoc=_xmlDoc@entry=0x7fffffffdda0) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2706\n#14 0x00007ffff76c7678 in sdf::URDF2SDF::InitModelFile (this=this@entry=0x7fffffffde6d, _filename=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2715\n#15 0x00007ffff76a1aa3 in sdf::readFile (_filename=..., _sdf=...) at /build/buildd/sdformat-1.4.11/src/parser.cc:265\n#16 0x0000000000403e60 in main ()\n```\n\n**Problem explanation:**\n\nSome details of the problem:\n\n * Ubuntu 1.4.11 sdformat was built on 2013-11-07\n * Ubuntu 1.4.11 includes the patch in the [PR 77](#!/osrf/sdformat/pull-request/77/support-to-use-external-urdf) which was merged 2013-12-17\n * OSRF/ROS deb packages 1.4.11 does not have PR77 \n\nSo due to patching, packages are not exactly the same in OSRF/ROS repo and Ubuntu. Ubuntu ones includes PR 77.\n\nMy hypothesis is that we made PR77 considering urdfdom-0.3.0. Looks like the [there was a change](https://github.com/ros/urdfdom_headers/compare/0.2.3...0.3.0 ) in the way of handling visual and collision arrays: \n\n```\n-  /// if more than one collision element is specified, all collision elements are placed in this array (the collision member will be NULL)\n+  /// if more than one collision element is specified, all collision elements are placed in this array (the collision member points to the first element of the array)\n   std::vector<boost::shared_ptr<Collision> > collision_array;\n\n... same for visual array\n```\n\nSo we are creating the bug when using urdfdom-0.2.3 and activate the USE_EXTERNAL_URDF flag\n\n**Workaround:**\n\nI did a quick test and generate an [sdformat-1.4.11-1osrf1 package](http://www.gazebosim.org/assets/distributions/libsdformat1_1.4.11-1osrf1_amd64.deb) removing the code in PR77. It can work just doing:\n\n```\napt-get install gazebo2\ndpkg -i libsdformat1_1.4.11-1osrf1_amd64.deb\n```\n\n**Proper fix:**\n\nI need to start a bug in ubuntu to get rid of the patch in the 1.4.11 package so we get the fix from official repositories as soon as possible. Also, generate a gazebo2 version which depends on this patched version and above.", "markup": "markdown", "html": "<p><strong>Problem description: </strong></p>\n<p>After fixing the problem with ROS urdfdom package, there is still a different error found by  @jbinney:</p>\n<div class=\"codehilite\"><pre><span></span>jbinney@h-&gt; gzsdf print nao.urdf \n*** Error in `gzsdf&#39;: free(): invalid pointer: 0x0000000001ea4b70 ***\nAborted (core dumped)\n\njbinney@h-&gt; which gzsdf\n/usr/bin/gzsdf\n\njbinney@h-&gt; ldd /usr/bin/gzsdf | grep urdf                                                                                                \n        liburdfdom_model.so.0.2 =&gt; /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2 (0x00007f1cb8542000)\n\njbinney@h-&gt; dpkg -S /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2\nliburdfdom-model0.2:amd64: /usr/lib/x86_64-linux-gnu/liburdfdom_model.so.0.2\n</pre></div>\n\n\n<p>I run gdb against it and looks like the same issue that we <a data-is-external-link=\"true\" href=\"#!/osrf/sdformat/pull-request/77/support-to-use-external-urdf/diff#comment-917387\" rel=\"nofollow\">were fixing before</a>.</p>\n<div class=\"codehilite\"><pre><span></span>(gdb) run print nao.urdf\nStarting program: /usr/bin/gzsdf print nao.urdf\n[Thread debugging using libthread_db enabled]\nUsing host libthread_db library &quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.\n[New Thread 0x7fffe8338700 (LWP 4525)]\n*** Error in `/usr/bin/gzsdf&#39;: free(): invalid pointer: 0x00000000008ad5f0 ***\n\nProgram received signal SIGABRT, Aborted.\n0x00007ffff6db6f79 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\n56  ../nptl/sysdeps/unix/sysv/linux/raise.c: No such file or directory.\n(gdb) bt\n#0  0x00007ffff6db6f79 in __GI_raise (sig=sig@entry=6) at ../nptl/sysdeps/unix/sysv/linux/raise.c:56\n#1  0x00007ffff6dba388 in __GI_abort () at abort.c:89\n#2  0x00007ffff6df41d4 in __libc_message (do_abort=do_abort@entry=1, fmt=fmt@entry=0x7ffff6f02a10 &quot;*** Error in `%s&#39;: %s: 0x%s ***\\n&quot;) at ../sysdeps/posix/libc_fatal.c:175\n#3  0x00007ffff6e004ae in malloc_printerr (ptr=&lt;optimized out&gt;, str=0x7ffff6efeb03 &quot;free(): invalid pointer&quot;, action=1) at malloc.c:4996\n#4  _int_free (av=&lt;optimized out&gt;, p=&lt;optimized out&gt;, have_lock=0) at malloc.c:3840\n#5  0x00007ffff768549e in boost::detail::sp_counted_base::release (this=0x8b8df0) at /usr/include/boost/smart_ptr/detail/sp_counted_base_gcc_x86.hpp:146\n#6  0x00007ffff76bb53d in ~shared_count (this=&lt;synthetic pointer&gt;, __in_chrg=&lt;optimized out&gt;) at /usr/include/boost/smart_ptr/detail/shared_count.hpp:371\n#7  ~shared_ptr (this=&lt;synthetic pointer&gt;, __in_chrg=&lt;optimized out&gt;) at /usr/include/boost/smart_ptr/shared_ptr.hpp:328\n#8  ReduceVisualToParent (_link=..., _groupName=..., _visual=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:378\n#9  0x00007ffff76bbba4 in ReduceVisualsToParent (_link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:887\n#10 0x00007ffff76c671f in ReduceFixedJoints (_root=_root@entry=0x870a30, _link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:405\n#11 0x00007ffff76c6467 in ReduceFixedJoints (_root=_root@entry=0x870a30, _link=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:390\n#12 0x00007ffff76c6f12 in sdf::URDF2SDF::InitModelString (this=this@entry=0x7fffffffde6d, _urdfStr=..., _enforceLimits=_enforceLimits@entry=true) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2667\n#13 0x00007ffff76c7514 in sdf::URDF2SDF::InitModelDoc (this=this@entry=0x7fffffffde6d, _xmlDoc=_xmlDoc@entry=0x7fffffffdda0) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2706\n#14 0x00007ffff76c7678 in sdf::URDF2SDF::InitModelFile (this=this@entry=0x7fffffffde6d, _filename=...) at /build/buildd/sdformat-1.4.11/src/parser_urdf.cc:2715\n#15 0x00007ffff76a1aa3 in sdf::readFile (_filename=..., _sdf=...) at /build/buildd/sdformat-1.4.11/src/parser.cc:265\n#16 0x0000000000403e60 in main ()\n</pre></div>\n\n\n<p><strong>Problem explanation:</strong></p>\n<p>Some details of the problem:</p>\n<ul>\n<li>Ubuntu 1.4.11 sdformat was built on 2013-11-07</li>\n<li>Ubuntu 1.4.11 includes the patch in the <a data-is-external-link=\"true\" href=\"#!/osrf/sdformat/pull-request/77/support-to-use-external-urdf\" rel=\"nofollow\">PR 77</a> which was merged 2013-12-17</li>\n<li>OSRF/ROS deb packages 1.4.11 does not have PR77 </li>\n</ul>\n<p>So due to patching, packages are not exactly the same in OSRF/ROS repo and Ubuntu. Ubuntu ones includes PR 77.</p>\n<p>My hypothesis is that we made PR77 considering urdfdom-0.3.0. Looks like the <a data-is-external-link=\"true\" href=\"https://github.com/ros/urdfdom_headers/compare/0.2.3...0.3.0\" rel=\"nofollow\">there was a change</a> in the way of handling visual and collision arrays: </p>\n<div class=\"codehilite\"><pre><span></span><span class=\"nt\">-</span>  <span class=\"o\">///</span> <span class=\"nt\">if</span> <span class=\"nt\">more</span> <span class=\"nt\">than</span> <span class=\"nt\">one</span> <span class=\"nt\">collision</span> <span class=\"nt\">element</span> <span class=\"nt\">is</span> <span class=\"nt\">specified</span><span class=\"o\">,</span> <span class=\"nt\">all</span> <span class=\"nt\">collision</span> <span class=\"nt\">elements</span> <span class=\"nt\">are</span> <span class=\"nt\">placed</span> <span class=\"nt\">in</span> <span class=\"nt\">this</span> <span class=\"nt\">array</span> <span class=\"o\">(</span><span class=\"nt\">the</span> <span class=\"nt\">collision</span> <span class=\"nt\">member</span> <span class=\"nt\">will</span> <span class=\"nt\">be</span> <span class=\"nt\">NULL</span><span class=\"o\">)</span>\n<span class=\"o\">+</span>  <span class=\"o\">///</span> <span class=\"nt\">if</span> <span class=\"nt\">more</span> <span class=\"nt\">than</span> <span class=\"nt\">one</span> <span class=\"nt\">collision</span> <span class=\"nt\">element</span> <span class=\"nt\">is</span> <span class=\"nt\">specified</span><span class=\"o\">,</span> <span class=\"nt\">all</span> <span class=\"nt\">collision</span> <span class=\"nt\">elements</span> <span class=\"nt\">are</span> <span class=\"nt\">placed</span> <span class=\"nt\">in</span> <span class=\"nt\">this</span> <span class=\"nt\">array</span> <span class=\"o\">(</span><span class=\"nt\">the</span> <span class=\"nt\">collision</span> <span class=\"nt\">member</span> <span class=\"nt\">points</span> <span class=\"nt\">to</span> <span class=\"nt\">the</span> <span class=\"nt\">first</span> <span class=\"nt\">element</span> <span class=\"nt\">of</span> <span class=\"nt\">the</span> <span class=\"nt\">array</span><span class=\"o\">)</span>\n   <span class=\"nt\">std</span><span class=\"p\">::</span><span class=\"nd\">vector</span><span class=\"o\">&lt;</span><span class=\"nt\">boost</span><span class=\"p\">::</span><span class=\"nd\">shared_ptr</span><span class=\"o\">&lt;</span><span class=\"nt\">Collision</span><span class=\"o\">&gt;</span> <span class=\"o\">&gt;</span> <span class=\"nt\">collision_array</span><span class=\"o\">;</span>\n\n<span class=\"o\">...</span> <span class=\"nt\">same</span> <span class=\"nt\">for</span> <span class=\"nt\">visual</span> <span class=\"nt\">array</span>\n</pre></div>\n\n\n<p>So we are creating the bug when using urdfdom-0.2.3 and activate the USE_EXTERNAL_URDF flag</p>\n<p><strong>Workaround:</strong></p>\n<p>I did a quick test and generate an <a data-is-external-link=\"true\" href=\"http://www.gazebosim.org/assets/distributions/libsdformat1_1.4.11-1osrf1_amd64.deb\" rel=\"nofollow\">sdformat-1.4.11-1osrf1 package</a> removing the code in PR77. It can work just doing:</p>\n<div class=\"codehilite\"><pre><span></span>apt-get install gazebo2\ndpkg -i libsdformat1_1.4.11-1osrf1_amd64.deb\n</pre></div>\n\n\n<p><strong>Proper fix:</strong></p>\n<p>I need to start a bug in ubuntu to get rid of the patch in the 1.4.11 package so we get the fix from official repositories as soon as possible. Also, generate a gazebo2 version which depends on this patched version and above.</p>", "type": "rendered"}, "created_on": "2014-07-02T00:06:13.940175+00:00", "user": {"display_name": "Jose Luis Rivero", "uuid": "{d12309b2-f745-42ee-b119-aec4fcdf81fe}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D"}, "html": {"href": "https://bitbucket.org/%7Bd12309b2-f745-42ee-b119-aec4fcdf81fe%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/109284c8b83411dbc7492138f6167e9ed=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJR-5.png"}}, "nickname": "Jose Luis Rivero", "type": "user", "account_id": "557058:155a32e2-420c-4d50-98e0-0e722f63f906"}, "updated_on": null, "type": "issue_comment", "id": 11016112}