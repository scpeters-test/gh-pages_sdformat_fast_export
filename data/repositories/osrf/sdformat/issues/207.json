{"priority": "major", "kind": "bug", "repository": {"links": {"self": {"href": "data/repositories/osrf/sdformat.json"}, "html": {"href": "#!/osrf/sdformat"}, "avatar": {"href": "data/bytebucket.org/ravatar/{b6d52f9f-b070-41c0-807c-94af07ea375b}ts=1606789"}}, "type": "repository", "name": "sdformat", "full_name": "osrf/sdformat", "uuid": "{b6d52f9f-b070-41c0-807c-94af07ea375b}"}, "links": {"attachments": {"href": "data/repositories/osrf/sdformat/issues/207/attachments_page=1.json"}, "self": {"href": "data/repositories/osrf/sdformat/issues/207.json"}, "watch": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/sdformat/issues/207/watch"}, "comments": {"href": "data/repositories/osrf/sdformat/issues/207/comments_page=1.json"}, "html": {"href": "#!/osrf/sdformat/issues/207/error-when-starting-ign-gazebo-if"}, "vote": {"href": "https://api.bitbucket.org/2.0/repositories/osrf/sdformat/issues/207/vote"}}, "reporter": {"display_name": "Silvio Traversaro", "uuid": "{34f404cb-5642-4f27-a032-e04c7143d776}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B34f404cb-5642-4f27-a032-e04c7143d776%7D"}, "html": {"href": "https://bitbucket.org/%7B34f404cb-5642-4f27-a032-e04c7143d776%7D/"}, "avatar": {"href": "https://avatar-management--avatars.us-west-2.prod.public.atl-paas.net/557058:e1c3e6a0-9a64-4e5f-a668-feebc191c5b6/578caaa1-056c-45a2-8bf9-bee94c3bebef/128"}}, "nickname": "traversaro", "type": "user", "account_id": "557058:e1c3e6a0-9a64-4e5f-a668-feebc191c5b6"}, "title": "Error when starting ign-gazebo if LC_NUMERIC in set to a locale with comma as a decimal separator", "component": null, "votes": 0, "watches": 1, "content": {"raw": "# Prerequisites\r\n\r\n* [x] Put an X between the brackets on this line if you have done all of the following:\r\n    * Checked the Q&A board for common solutions: http://answers.gazebosim.org\r\n    * Checked that your issue isn't already filed.\r\n    * Checked that there is not already an Ignition package that provides the described functionality: https://ignitionrobotics.org/libs\r\n\r\n# Description \r\n\r\nRemake of #!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric . : )\r\n\r\nI recently tried to test the work in progress version of ign-gazebo, and on my system I got a locale-related error (similar to\r\n#!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric  , https://github.com/ros/urdfdom/issues/98 \r\nand https://github.com/ros/urdfdom/issues/98). \r\n\r\n# Steps to Reproduce\r\n\r\nLaunch `ign-gazebo` with a locale in  which the decimal separator is not `.`: \r\n~~~\r\nLC_NUMERIC=it_IT ign-gazebo\r\n~~~ \r\n\r\n**Expected behavior:**  \r\nIf launched with the `C` locale, `ign-gazebo` start correctly:\r\n~~~\r\nstraversaro@iiticublap103:~/src/gazebo-superbuild/build-ign-gcc-8/install/bin$ LC_ALL=\"C\" ./ign-gazebo --verbose 3\r\n[Msg] Ignition Gazebo v0.1.0~pre1\r\n[GUI] [Msg] Loading config [/home/straversaro/src/gazebo-superbuild/build-ign-gcc-8/install/share/ignition/gazebo0/gui/gui.config]\r\n[GUI] [Msg] World [default] initialized with [default_physics] physics profile.\r\n[GUI] [Msg] Loading plugin [Scene3D]\r\n[GUI] [Msg] Added plugin [3D View] to main window\r\n[GUI] [Msg] Loading plugin [WorldControl]\r\n[GUI] [Msg] Added plugin [World control] to main window\r\n[GUI] [Msg] Loading plugin [WorldStats]\r\n[GUI] [Msg] Added plugin [World stats] to main window\r\n[GUI] [Msg] Serving scene information on [/world/default/scene/info]\r\n[GUI] [Msg] Serving scene graph on [/world/default/scene/graph]\r\n[GUI] [Msg] Publishing pose messages on [/world/default/pose/info]\r\n[GUI] [Msg] Loading plugin [ignition-rendering1-ogre]\r\n~~~\r\n\r\n**Actual behavior:**\r\n\r\n~~~\r\nstraversaro@iiticublap103:~/src/gazebo-superbuild/build-ign-gcc-8/install/bin$ ./ign-gazebo --verbose 3\r\n[Msg] Ignition Gazebo v0.1.0~pre1\r\n[GUI] [Msg] Loading config [/home/straversaro/src/gazebo-superbuild/build-ign-gcc-8/install/share/ignition/gazebo0/gui/gui.config]\r\nError [Param.cc:395] Invalid argument. Unable to set value [.1 ] for key[near].\r\nException [Param.cc:44] SDF ASSERTION                     \r\nInvalid parameter\r\nIn function       : Param\r\nAssert expression : this->ValueFromString(_default)\r\nterminate called after throwing an instance of 'sdf::v8::AssertionInternalError'\r\nAborted (core dumped)\r\n~~~  \r\n\r\n**Reproduces how often:** \r\n\r\nEverytime. \r\n\r\n# Versions\r\n\r\nUbuntu 18.04\r\nsdformat branch : `gz11` \r\n\r\n# Additional Information\r\nChecking the backtrace, it seems that the call sequence is: \r\nsdf::Element::AddValue --> sdf::Element::CreateParam --> sdf::Param::Param --> sdf::Param::ValueFromString\r\n\r\nA related commit is #!/osrf/sdformat/commits/f6af03cf3a63d3a6dd1492a2f6031475625a71cd , \r\nbut I am not sure why I never experienced this,  as `template<typename T> void Param::Init(const std::string &_value)` \r\nmethod was prone to this locale error as well.\r\n\r\nA proper solution could be to substitute calls to `str::stod` with a locale-safe custom function as done in \r\nhttps://github.com/ros/urdfdom_headers/pull/42/files . An alternative, for the branch of SDFormat that support C++17\r\nwould be to use [`std::from_chars`](https://en.cppreference.com/w/cpp/utility/from_chars). Unfortunately, not all the strings\r\nthat represent a valid XML floating point number are valid inputs to `std::from_chars` (for example, `+1.0` is not a valid input to\r\n`std::to_chars`), so even this is not a trivial solution.", "markup": "markdown", "html": "<h1 id=\"markdown-header-prerequisites\">Prerequisites</h1>\n<ul>\n<li>[x] Put an X between the brackets on this line if you have done all of the following:<ul>\n<li>Checked the Q&amp;A board for common solutions: <a href=\"http://answers.gazebosim.org\" rel=\"nofollow\" class=\"ap-connect-link\">http://answers.gazebosim.org</a></li>\n<li>Checked that your issue isn't already filed.</li>\n<li>Checked that there is not already an Ignition package that provides the described functionality: <a href=\"https://ignitionrobotics.org/libs\" rel=\"nofollow\" class=\"ap-connect-link\">https://ignitionrobotics.org/libs</a></li>\n</ul>\n</li>\n</ul>\n<h1 id=\"markdown-header-description\">Description</h1>\n<p>Remake of <a href=\"#!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric\" rel=\"nofollow\" class=\"ap-connect-link\">#!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric</a> . : )</p>\n<p>I recently tried to test the work in progress version of ign-gazebo, and on my system I got a locale-related error (similar to\n<a href=\"#!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric\" rel=\"nofollow\" class=\"ap-connect-link\">#!/osrf/sdformat/issues/60/error-when-starting-gazebo-if-lc_numeric</a>  , <a href=\"https://github.com/ros/urdfdom/issues/98\" rel=\"nofollow\" class=\"ap-connect-link\">https://github.com/ros/urdfdom/issues/98</a> \nand <a href=\"https://github.com/ros/urdfdom/issues/98\" rel=\"nofollow\" class=\"ap-connect-link\">https://github.com/ros/urdfdom/issues/98</a>). </p>\n<h1 id=\"markdown-header-steps-to-reproduce\">Steps to Reproduce</h1>\n<p>Launch <code>ign-gazebo</code> with a locale in  which the decimal separator is not <code>.</code>: </p>\n<div class=\"codehilite\"><pre><span></span>LC_NUMERIC=it_IT ign-gazebo\n</pre></div>\n\n\n<p><strong>Expected behavior:</strong><br />\nIf launched with the <code>C</code> locale, <code>ign-gazebo</code> start correctly:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">straversaro</span><span class=\"p\">@</span><span class=\"nl\">iiticublap103</span><span class=\"p\">:</span><span class=\"o\">~/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">gazebo</span><span class=\"o\">-</span><span class=\"n\">superbuild</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">-</span><span class=\"n\">ign</span><span class=\"o\">-</span><span class=\"n\">gcc</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">install</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"err\">$</span> <span class=\"n\">LC_ALL</span><span class=\"o\">=</span><span class=\"s\">&quot;C&quot;</span> <span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">ign</span><span class=\"o\">-</span><span class=\"n\">gazebo</span> <span class=\"o\">--</span><span class=\"n\">verbose</span> <span class=\"mi\">3</span>\n<span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Ignition</span> <span class=\"n\">Gazebo</span> <span class=\"n\">v0</span><span class=\"mf\">.1.0</span><span class=\"o\">~</span><span class=\"n\">pre1</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Loading</span> <span class=\"n\">config</span> <span class=\"p\">[</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">straversaro</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">gazebo</span><span class=\"o\">-</span><span class=\"n\">superbuild</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">-</span><span class=\"n\">ign</span><span class=\"o\">-</span><span class=\"n\">gcc</span><span class=\"o\">-</span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"n\">install</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">ignition</span><span class=\"o\">/</span><span class=\"n\">gazebo0</span><span class=\"o\">/</span><span class=\"n\">gui</span><span class=\"o\">/</span><span class=\"n\">gui</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">World</span> <span class=\"p\">[</span><span class=\"k\">default</span><span class=\"p\">]</span> <span class=\"n\">initialized</span> <span class=\"n\">with</span> <span class=\"p\">[</span><span class=\"n\">default_physics</span><span class=\"p\">]</span> <span class=\"n\">physics</span> <span class=\"n\">profile</span><span class=\"p\">.</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Loading</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">Scene3D</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Added</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"n\">D</span> <span class=\"n\">View</span><span class=\"p\">]</span> <span class=\"n\">to</span> <span class=\"n\">main</span> <span class=\"n\">window</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Loading</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">WorldControl</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Added</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">World</span> <span class=\"n\">control</span><span class=\"p\">]</span> <span class=\"n\">to</span> <span class=\"n\">main</span> <span class=\"n\">window</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Loading</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">WorldStats</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Added</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">World</span> <span class=\"n\">stats</span><span class=\"p\">]</span> <span class=\"n\">to</span> <span class=\"n\">main</span> <span class=\"n\">window</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Serving</span> <span class=\"n\">scene</span> <span class=\"n\">information</span> <span class=\"n\">on</span> <span class=\"p\">[</span><span class=\"o\">/</span><span class=\"n\">world</span><span class=\"o\">/</span><span class=\"k\">default</span><span class=\"o\">/</span><span class=\"n\">scene</span><span class=\"o\">/</span><span class=\"n\">info</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Serving</span> <span class=\"n\">scene</span> <span class=\"n\">graph</span> <span class=\"n\">on</span> <span class=\"p\">[</span><span class=\"o\">/</span><span class=\"n\">world</span><span class=\"o\">/</span><span class=\"k\">default</span><span class=\"o\">/</span><span class=\"n\">scene</span><span class=\"o\">/</span><span class=\"n\">graph</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Publishing</span> <span class=\"n\">pose</span> <span class=\"n\">messages</span> <span class=\"n\">on</span> <span class=\"p\">[</span><span class=\"o\">/</span><span class=\"n\">world</span><span class=\"o\">/</span><span class=\"k\">default</span><span class=\"o\">/</span><span class=\"n\">pose</span><span class=\"o\">/</span><span class=\"n\">info</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"n\">GUI</span><span class=\"p\">]</span> <span class=\"p\">[</span><span class=\"n\">Msg</span><span class=\"p\">]</span> <span class=\"n\">Loading</span> <span class=\"n\">plugin</span> <span class=\"p\">[</span><span class=\"n\">ignition</span><span class=\"o\">-</span><span class=\"n\">rendering1</span><span class=\"o\">-</span><span class=\"n\">ogre</span><span class=\"p\">]</span>\n</pre></div>\n\n\n<p><strong>Actual behavior:</strong></p>\n<div class=\"codehilite\"><pre><span></span>straversaro@iiticublap103:~/src/gazebo-superbuild/build-ign-gcc-8/install/bin$ ./ign-gazebo --verbose 3\n[Msg] Ignition Gazebo v0.1.0~pre1\n[GUI] [Msg] Loading config [/home/straversaro/src/gazebo-superbuild/build-ign-gcc-8/install/share/ignition/gazebo0/gui/gui.config]\nError [Param.cc:395] Invalid argument. Unable to set value [.1 ] for key[near].\nException [Param.cc:44] SDF ASSERTION                     \nInvalid parameter\nIn function       : Param\nAssert expression : this-&gt;ValueFromString(_default)\nterminate called after throwing an instance of &#39;sdf::v8::AssertionInternalError&#39;\nAborted (core dumped)\n</pre></div>\n\n\n<p><strong>Reproduces how often:</strong> </p>\n<p>Everytime. </p>\n<h1 id=\"markdown-header-versions\">Versions</h1>\n<p>Ubuntu 18.04\nsdformat branch : <code>gz11</code> </p>\n<h1 id=\"markdown-header-additional-information\">Additional Information</h1>\n<p>Checking the backtrace, it seems that the call sequence is: \nsdf::Element::AddValue --&gt; sdf::Element::CreateParam --&gt; sdf::Param::Param --&gt; sdf::Param::ValueFromString</p>\n<p>A related commit is <a href=\"#!/osrf/sdformat/commits/f6af03cf3a63d3a6dd1492a2f6031475625a71cd\" rel=\"nofollow\" class=\"ap-connect-link\">#!/osrf/sdformat/commits/f6af03cf3a63d3a6dd1492a2f6031475625a71cd</a> , \nbut I am not sure why I never experienced this,  as <code>template&lt;typename T&gt; void Param::Init(const std::string &amp;_value)</code> \nmethod was prone to this locale error as well.</p>\n<p>A proper solution could be to substitute calls to <code>str::stod</code> with a locale-safe custom function as done in \n<a href=\"https://github.com/ros/urdfdom_headers/pull/42/files\" rel=\"nofollow\" class=\"ap-connect-link\">https://github.com/ros/urdfdom_headers/pull/42/files</a> . An alternative, for the branch of SDFormat that support C++17\nwould be to use <a data-is-external-link=\"true\" href=\"https://en.cppreference.com/w/cpp/utility/from_chars\" rel=\"nofollow\"><code>std::from_chars</code></a>. Unfortunately, not all the strings\nthat represent a valid XML floating point number are valid inputs to <code>std::from_chars</code> (for example, <code>+1.0</code> is not a valid input to\n<code>std::to_chars</code>), so even this is not a trivial solution.</p>", "type": "rendered"}, "assignee": null, "state": "resolved", "version": null, "edited_on": null, "created_on": "2018-11-13T00:15:25.332623+00:00", "milestone": null, "updated_on": "2019-01-04T23:01:50.256835+00:00", "type": "issue", "id": 207}